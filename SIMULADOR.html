<!DOCTYPE html>
<html>

<head>
    <title>Tanques v2 - Simulador y Registro</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        #messages {
            border: 1px solid #444;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            background: #000;
            margin-top: 10px;
            border-radius: 4px;
        }

        input {
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #444;
            color: white;
        }

        button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .section {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #555;
        }

        label {
            display: inline-block;
            width: 80px;
        }
    </style>
</head>

<body>
    <h1>ğŸ® Mi Simulador de Tanques v2</h1>

    <!-- I. MI ZONA DE REGISTRO (Nueva) -->
    <div class="section">
        <h3>ğŸ”‘ 1. Registro de mi Jugador</h3>
        <p style="font-size: 0.9em; color: #aaa;">Primero tengo que crearme una cuenta si no la tengo.</p>
        <input type="text" id="reg_username" placeholder="Nombre usuario">
        <input type="password" id="reg_password" placeholder="ContraseÃ±a">
        <button onclick="registerUser()" style="background: #007bff;">Crear Cuenta</button>
        <div id="reg_status" style="margin-top: 10px; font-weight: bold;"></div>
    </div>

    <!-- II. MI SISTEMA DE PUNTUACIÃ“N -->
    <div class="section">
        <h3>ğŸ† 2. Ranking y PuntuaciÃ³n</h3>
        <div>
            <h4>Simular Fin de Partida</h4>
            <input type="number" id="time_taken" placeholder="Tiempo (seg)" value="120">
            <input type="number" id="damage_taken" placeholder="DaÃ±o Recibido" value="50">
            <select id="level_reached">
                <option value="1">Nivel 1</option>
                <option value="2">Nivel 2</option>
                <option value="3" selected>Nivel 3 (Victoria)</option>
            </select>
            <button onclick="submitScore()">Enviar PuntuaciÃ³n</button>
            <div id="score_result" style="color: #bbb; margin-top: 5px;"></div>
        </div>
        <hr style="border-color: #555;">
        <div>
            <h4>Top 10 Jugadores</h4>
            <button onclick="getLeaderboard()" style="background: #e0a800;">ğŸ”„ Actualizar Tabla</button>
            <ul id="leaderboard_list" style="background: #111; padding: 10px; list-style: none;"></ul>
        </div>
    </div>

    <!-- III. CONSOLA -->
    <div class="section">
        <h3>ğŸ“ Estado</h3>
        <div id="messages"></div>
    </div>

    <script>
        // --- MI LÃ“GICA DE REGISTRO (HTTP) ---
        async function registerUser() {
            const user = document.getElementById('reg_username').value;
            const pass = document.getElementById('reg_password').value;
            const statusDiv = document.getElementById('reg_status');

            statusDiv.innerText = "Mandando registro...";
            statusDiv.style.color = "#eee";

            try {
                const response = await fetch('http://localhost:8000/users/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerText = `âœ… Â¡Hecho! El usuario '${user}' ya puede jugar.`;
                    statusDiv.style.color = "#28a745";
                } else {
                    statusDiv.innerText = `âŒ Fallo: ${data.detail || "Datos invÃ¡lidos"}`;
                    statusDiv.style.color = "#dc3545";
                }
            } catch (error) {
                statusDiv.innerText = "âŒ No hay respuesta del servidor. Â¿EstÃ¡ encendido?";
                statusDiv.style.color = "#dc3545";
            }
        }

        // --- MI LÃ“GICA DE RANKING ---
        async function submitScore() {
            const user = document.getElementById('reg_username').value;
            if (!user) { alert("Pon un nombre de usuario arriba primero"); return; }

            const time = parseInt(document.getElementById('time_taken').value);
            const dmg = parseInt(document.getElementById('damage_taken').value);
            const level = parseInt(document.getElementById('level_reached').value);

            try {
                const res = await fetch(`http://localhost:8000/users/${user}/submit-score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tiempo_segundos: time, daÃ±o_recibido: dmg, nivel_alcanzado: level })
                });
                const data = await res.json();

                let msg = `Puntos: ${data.score_partida}. `;
                if (data.nuevo_record) msg += "ğŸ‰ NUEVO RÃ‰CORD!";
                else msg += `(RÃ©cord actual: ${data.high_score_actual})`;

                document.getElementById('score_result').innerText = msg;
                getLeaderboard();
            } catch (e) {
                console.error(e);
                alert("Error enviando puntuaciÃ³n");
            }
        }

        async function getLeaderboard() {
            try {
                const res = await fetch('http://localhost:8000/users/ranking/top');
                const data = await res.json();
                const list = document.getElementById('leaderboard_list');
                list.innerHTML = "";

                data.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.style.padding = "5px";
                    li.style.borderBottom = "1px solid #333";
                    let prefix = `#${index + 1}`;
                    if (index === 0) prefix = "ğŸ¥‡";
                    if (index === 1) prefix = "ğŸ¥ˆ";
                    if (index === 2) prefix = "ğŸ¥‰";

                    li.innerText = `${prefix} ${player.username}: ${player.score} pts`;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>

</html>