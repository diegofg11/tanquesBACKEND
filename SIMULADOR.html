<!DOCTYPE html>
<html>

<head>
    <title>Tanques v2 - Simulador y Registro</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        #messages {
            border: 1px solid #444;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            background: #000;
            margin-top: 10px;
            border-radius: 4px;
        }

        input {
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #444;
            color: white;
        }

        button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .section {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #555;
        }

        label {
            display: inline-block;
            width: 80px;
        }
    </style>
</head>

<body>
    <h1>üéÆ Mi Simulador de Tanques v2</h1>

    <!-- I. MI ZONA DE REGISTRO (Nueva) -->
    <div class="section">
        <h3>üîë 1. Registro de mi Jugador</h3>
        <p style="font-size: 0.9em; color: #aaa;">Primero tengo que crearme una cuenta si no la tengo.</p>
        <input type="text" id="reg_username" placeholder="Nombre usuario">
        <input type="password" id="reg_password" placeholder="Contrase√±a">
        <button onclick="registerUser()" style="background: #007bff;">Crear Cuenta</button>
        <div id="reg_status" style="margin-top: 10px; font-weight: bold;"></div>
    </div>

    <!-- II. MI CONEXI√ìN A LA PARTIDA -->
    <div class="section">
        <h3>üöÄ 2. Conexi√≥n al Juego</h3>
        <input type="text" id="username" placeholder="Mi nombre registrado">
        <input type="text" id="room_id" placeholder="ID de la Sala" value="PARTIDA_1">
        <button onclick="connect()">Entrar a la Sala</button>
        <div id="status" style="margin-top: 10px; font-weight: bold;">Estado: Desconectado</div>
    </div>

    <!-- III. MI PANEL DE CONTROL -->
    <div class="section">
        <h3>üïπÔ∏è 3. Mis Mandos</h3>
        <div>
            <label>Pos (X):</label> <input type="range" id="posX" min="0" max="1000" value="500"> <br>
            <label>Pos (Y):</label> <input type="range" id="posY" min="0" max="1000" value="500"> <br>
            <label>Rotaci√≥n:</label> <input type="range" id="rot" min="0" max="360" value="0"> <br>
            <label>Vida (HP):</label> <input type="range" id="hp" min="0" max="100" value="100">
        </div>
        <br>
        <button id="sendBtn" onclick="sendMovement()" disabled style="width: 100%;">Mandar mi posici√≥n a los
            dem√°s</button>
    </div>

    <!-- IV. MI CONSOLA -->
    <div class="section">
        <h3>üìù Mi Consola de Partida</h3>
        <div id="messages"></div>
    </div>

    <!-- V. MI SISTEMA DE PUNTUACI√ìN (NUEVO) -->
    <div class="section">
        <h3>üèÜ 4. Ranking y Puntuaci√≥n</h3>
        <div>
            <h4>Simular Fin de Partida</h4>
            <input type="number" id="time_taken" placeholder="Tiempo (seg)" value="120">
            <input type="number" id="damage_taken" placeholder="Da√±o Recibido" value="50">
            <select id="level_reached">
                <option value="1">Nivel 1</option>
                <option value="2">Nivel 2</option>
                <option value="3" selected>Nivel 3 (Victoria)</option>
            </select>
            <button onclick="submitScore()">Enviar Puntuaci√≥n</button>
            <div id="score_result" style="color: #bbb; margin-top: 5px;"></div>
        </div>
        <hr style="border-color: #555;">
        <div>
            <h4>Top 10 Jugadores</h4>
            <button onclick="getLeaderboard()" style="background: #e0a800;">üîÑ Actualizar Tabla</button>
            <ul id="leaderboard_list" style="background: #111; padding: 10px; list-style: none;"></ul>
        </div>
    </div>

    <script>
        // ... (L√≥gica de registro y websocket existente) ...
        // --- MI L√ìGICA DE REGISTRO (HTTP) ---
        async function registerUser() {
            const user = document.getElementById('reg_username').value;
            const pass = document.getElementById('reg_password').value;
            const statusDiv = document.getElementById('reg_status');

            statusDiv.innerText = "Mandando registro...";
            statusDiv.style.color = "#eee";

            try {
                // Llamo a mi API por la v√≠a normal (HTTP)
                const response = await fetch('http://localhost:8000/users/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerText = `‚úÖ ¬°Hecho! El usuario '${user}' ya puede jugar.`;
                    statusDiv.style.color = "#28a745";
                } else {
                    statusDiv.innerText = `‚ùå Fallo: ${data.detail || "Datos inv√°lidos"}`;
                    statusDiv.style.color = "#dc3545";
                }
            } catch (error) {
                statusDiv.innerText = "‚ùå No hay respuesta del servidor. ¬øEst√° encendido?";
                statusDiv.style.color = "#dc3545";
            }
        }

        // --- MI L√ìGICA DE JUEGO (WEBSOCKTS) ---
        let ws;

        function connect() {
            // Cierro lo viejo para no duplicar cables
            if (ws) ws.close();

            const user = document.getElementById('username').value;
            const room = document.getElementById('room_id').value;

            // Intento abrir mi tuber√≠a de datos
            ws = new WebSocket(`ws://localhost:8000/ws/game/${room}/${user}`);

            ws.onopen = function () {
                document.getElementById('status').innerText = `Estado: ¬°Dentro! Sala: ${room}`;
                document.getElementById('status').style.color = "#28a745";
                document.getElementById('sendBtn').disabled = false;
            };

            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);
                const messages = document.getElementById('messages');
                const div = document.createElement('div');

                if (data.tipo === "sistema") {
                    div.style.color = "#ffc107";
                    div.innerText = `[INFO] ${data.contenido}`;
                } else if (data.tipo === "movimiento") {
                    // Diferencio mis propios datos de los de mis rivales
                    const yo = document.getElementById('username').value;
                    const esMiEco = (data.jugador === yo);

                    const colorVida = data.datos.vida > 30 ? '#28a745' : '#dc3545';
                    div.innerHTML = `<b>${esMiEco ? 'YO' : data.jugador}:</b> X:${data.datos.x}, Y:${data.datos.y}, Rot:${data.datos.rotacion}¬∞, <b style="color: ${colorVida}">HP:${data.datos.vida}%</b>`;
                }

                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            };

            ws.onclose = function (event) {
                // Si el servidor me echa con c√≥digo 4003 es que no estoy registrado
                if (event.code === 4003) {
                    alert("¬°Quieto! Ese nombre no est√° registrado. Cr√©alo arriba primero.");
                }
                document.getElementById('status').innerText = "Estado: Desconectado";
                document.getElementById('status').style.color = "#dc3545";
                document.getElementById('sendBtn').disabled = true;
            };
        }

        function sendMovement() {
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            const rot = document.getElementById('rot').value;
            const vida = document.getElementById('hp').value;

            const payload = {
                x: parseInt(x), y: parseInt(y),
                rotacion: parseInt(rot), vida: parseInt(vida)
            };

            ws.send(JSON.stringify(payload));

            // Mi confirmaci√≥n azul local
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.style.color = "#007bff";
            div.innerHTML = `<i>[LOCAL] He enviado mi posici√≥n...</i>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        // --- MI L√ìGICA DE RANKING (NUEVA) ---
        async function submitScore() {
            const user = document.getElementById('reg_username').value || document.getElementById('username').value; // Intenta pillar el usuario de arriba
            if(!user) { alert("Pon un nombre de usuario arriba primero"); return; }
            
            const time = parseInt(document.getElementById('time_taken').value);
            const dmg = parseInt(document.getElementById('damage_taken').value);
            const level = parseInt(document.getElementById('level_reached').value);
            
            try {
                const res = await fetch(`http://localhost:8000/users/${user}/submit-score`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tiempo_segundos: time, da√±o_recibido: dmg, nivel_alcanzado: level })
                });
                const data = await res.json();
                
                let msg = `Puntos: ${data.score_partida}. `;
                if(data.nuevo_record) msg += "üéâ NUEVO R√âCORD!";
                else msg += `(R√©cord actual: ${data.high_score_actual})`;
                
                document.getElementById('score_result').innerText = msg;
                getLeaderboard(); // Actualizo la tabla ya que estamos
            } catch(e) {
                console.error(e);
                alert("Error enviando puntuaci√≥n");
            }
        }

        async function getLeaderboard() {
            try {
                const res = await fetch('http://localhost:8000/users/ranking/top');
                const data = await res.json();
                const list = document.getElementById('leaderboard_list');
                list.innerHTML = ""; // Limpio la lista
                
                data.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.style.padding = "5px";
                    li.style.borderBottom = "1px solid #333";
                    // Pongo medallas a los 3 primeros
                    let prefix = `#${index+1}`;
                    if(index===0) prefix = "ü•á";
                    if(index===1) prefix = "ü•à";
                    if(index===2) prefix = "ü•â";
                    
                    li.innerText = `${prefix} ${player.username}: ${player.score} pts`;
                    list.appendChild(li);
                });
            } catch(e) {
                console.error(e);
            }
        }
    </script>
</body>

</html>