<!DOCTYPE html>
<html>

<head>
    <title>Prueba Tanques WebSocket</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        #messages {
            border: 1px solid #444;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            background: #000;
        }

        input {
            padding: 10px;
            width: 70%;
        }

        button {
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Simulador de Tanque v2 (Salas + JSON)</h1>
    <div id="status">Desconectado</div>
    <div style="margin-bottom: 20px;">
        <input type="text" id="username" placeholder="Nombre de usuario" value="Tanque_1" style="width: 200px;">
        <input type="text" id="room_id" placeholder="ID de la Sala" value="PARTIDA_1" style="width: 150px;">
        <button onclick="connect()">Conectarse</button>
    </div>

    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h3>Control de Movimiento:</h3>
            <label>X: <input type="number" id="posX" value="0" style="width: 60px;"></label>
            <label>Y: <input type="number" id="posY" value="0" style="width: 60px;"></label>
            <br><br>
            <label>Rotación: <input type="range" id="rot" min="0" max="360" value="0"
                    oninput="this.nextElementSibling.value = this.value"> <output>0</output>°</label>
            <br><br>
            <label>Vida (HP): <input type="range" id="hp" min="0" max="100" value="100"
                    oninput="this.nextElementSibling.value = this.value"> <output>100</output>%</label>
            <br><br>
            <button id="sendBtn" onclick="sendMovement()" disabled style="background: #007bff;">Enviar JSON</button>
        </div>

        <div style="flex: 2;">
            <h3>Consola de la Sala:</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        // Aquí me guardo mi conexión para poder usarla en todas mis funciones.
        let ws;

        function connect() {
            // SI YA ESTABA CONECTADO (por ejemplo, si le doy dos veces al botón), 
            // cierro la conexión vieja para no tener cables duplicados y ver mensajes dobles.
            if (ws) {
                ws.close();
            }

            const username = document.getElementById('username').value;
            const room = document.getElementById('room_id').value;

            // Abro mi "tubería" (WebSocket) hacia el servidor.
            ws = new WebSocket(`ws://localhost:8000/ws/game/${room}/${username}`);

            // Este evento me salta cuando he logrado conectar bien.
            ws.onopen = function () {
                document.getElementById('status').innerText = `Estoy en la sala ${room} como ${username}`;
                document.getElementById('status').style.color = "#28a745";
                document.getElementById('sendBtn').disabled = false;
            };

            // Aquí recibo los mensajes que el servidor reparte a la sala.
            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);
                const messages = document.getElementById('messages');
                const messageDiv = document.createElement('div');

                if (data.tipo === "sistema") {
                    messageDiv.style.color = "#ffc107";
                    messageDiv.innerText = `[SISTEMA] ${data.contenido}`;
                } else if (data.tipo === "movimiento") {
                    // Si el nombre del jugador es el mío, pongo un prefijo para saber que es mi "eco" del servidor.
                    const yo = document.getElementById('username').value;
                    const prefijo = (data.jugador === yo) ? "MI ESTADO -> " : "";

                    const colorVida = data.datos.vida > 30 ? '#28a745' : '#dc3545';
                    messageDiv.innerHTML = `<b>${prefijo}${data.jugador}:</b> X:${data.datos.x}, Y:${data.datos.y}, Rot:${data.datos.rotacion}°, <b style="color: ${colorVida}">HP:${data.datos.vida}%</b>`;
                }

                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            };

            ws.onclose = function () {
                document.getElementById('status').innerText = "Vaya, me he desconectado";
                document.getElementById('status').style.color = "#dc3545";
                document.getElementById('sendBtn').disabled = true;
            };
        }

        function sendMovement() {
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            const rot = document.getElementById('rot').value;
            const vida = document.getElementById('hp').value;

            const payload = {
                x: parseInt(x),
                y: parseInt(y),
                rotacion: parseInt(rot),
                vida: parseInt(vida)
            };

            ws.send(JSON.stringify(payload));
        }
    </script>
</body>

</html>