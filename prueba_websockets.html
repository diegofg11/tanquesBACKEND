<!DOCTYPE html>
<html>

<head>
    <title>Prueba Tanques WebSocket</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        #messages {
            border: 1px solid #444;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            background: #000;
        }

        input {
            padding: 10px;
            width: 70%;
        }

        button {
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Simulador de Tanque v2 (Salas + JSON)</h1>
    <div id="status">Desconectado</div>
    <div style="margin-bottom: 20px;">
        <input type="text" id="username" placeholder="Nombre de usuario" value="Tanque_1" style="width: 200px;">
        <input type="text" id="room_id" placeholder="ID de la Sala" value="PARTIDA_1" style="width: 150px;">
        <button onclick="connect()">Conectarse</button>
    </div>

    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h3>Control de Movimiento:</h3>
            <label>X: <input type="number" id="posX" value="0" style="width: 60px;"></label>
            <label>Y: <input type="number" id="posY" value="0" style="width: 60px;"></label>
            <br><br>
            <label>Rotación: <input type="range" id="rot" min="0" max="360" value="0"
                    oninput="this.nextElementSibling.value = this.value"> <output>0</output>°</label>
            <br><br>
            <label>Vida (HP): <input type="range" id="hp" min="0" max="100" value="100"
                    oninput="this.nextElementSibling.value = this.value"> <output>100</output>%</label>
            <br><br>
            <button id="sendBtn" onclick="sendMovement()" disabled style="background: #007bff;">Enviar JSON</button>
        </div>

        <div style="flex: 2;">
            <h3>Consola de la Sala:</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        // Guardamos la conexión aquí para poder usarla en todas las funciones.
        let ws;

        function connect() {
            const username = document.getElementById('username').value;
            const room = document.getElementById('room_id').value;

            // Abrimos la "tubería" (WebSocket) hacia el servidor.
            // La URL ahora incluye la sala y el nombre para que el servidor nos identifique.
            ws = new WebSocket(`ws://localhost:8000/ws/game/${room}/${username}`);

            // Este evento se dispara cuando la conexión se abre correctamente.
            ws.onopen = function () {
                document.getElementById('status').innerText = `Conectado a ${room} como ${username}`;
                document.getElementById('status').style.color = "#28a745";
                document.getElementById('sendBtn').disabled = false;
            };

            // Aquí recibimos los mensajes que el servidor "reparte" a la sala.
            ws.onmessage = function (event) {
                // Convertimos el texto JSON que viene del servidor en un objeto JavaScript.
                const data = JSON.parse(event.data);
                const messages = document.getElementById('messages');
                const messageDiv = document.createElement('div');

                // Lógica para mostrar los mensajes según su tipo:
                if (data.tipo === "sistema") {
                    // Mensajes de entrada/salida de jugadores (color amarillo).
                    messageDiv.style.color = "#ffc107";
                    messageDiv.innerText = `[SISTEMA] ${data.contenido}`;
                } else if (data.tipo === "movimiento") {
                    // Datos de otro tanque (X, Y, Rotación y Vida).
                    // Usamos colores para que la vida sea más fácil de vigilar.
                    const colorVida = data.datos.vida > 30 ? '#28a745' : '#dc3545';
                    messageDiv.innerHTML = `<b>${data.jugador}:</b> movido a X:${data.datos.x}, Y:${data.datos.y}, Rot:${data.datos.rotacion}°, <b style="color: ${colorVida}">HP:${data.datos.vida}%</b>`;
                }

                // Añadimos el mensaje a la consola y hacemos scroll hacia abajo.
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            };

            // Si el servidor se apaga o perdemos internet, avisamos al usuario.
            ws.onclose = function () {
                document.getElementById('status').innerText = "Desconectado";
                document.getElementById('status').style.color = "#dc3545";
                document.getElementById('sendBtn').disabled = true;
            };
        }

        /**
         * Esta función empaqueta el estado actual del tanque en un JSON
         * y lo lanza por el WebSocket para que los demás lo vean.
         */
        function sendMovement() {
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            const rot = document.getElementById('rot').value;
            const vida = document.getElementById('hp').value;

            // Creamos el "contrato" de datos que compartiremos con Unity y otros clientes.
            const payload = {
                x: parseInt(x),
                y: parseInt(y),
                rotacion: parseInt(rot),
                vida: parseInt(vida)
            };

            // JSON.stringify convierte el objeto anterior en texto para poder enviarlo.
            ws.send(JSON.stringify(payload));
        }
    </script>
</body>

</html>