<!DOCTYPE html>
<html>

<head>
    <title>Prueba Tanques WebSocket</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        #messages {
            border: 1px solid #444;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            background: #000;
        }

        input {
            padding: 10px;
            width: 70%;
        }

        button {
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Simulador de Tanque v2 (Salas + JSON)</h1>
    <div id="status">Desconectado</div>
    <div style="margin-bottom: 20px;">
        <input type="text" id="username" placeholder="Nombre de usuario" value="Tanque_1" style="width: 200px;">
        <input type="text" id="room_id" placeholder="ID de la Sala" value="PARTIDA_1" style="width: 150px;">
        <button onclick="connect()">Conectarse</button>
    </div>

    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h3>Control de Movimiento:</h3>
            <label>X: <input type="number" id="posX" value="0" style="width: 60px;"></label>
            <label>Y: <input type="number" id="posY" value="0" style="width: 60px;"></label>
            <br><br>
            <label>Rotación: <input type="range" id="rot" min="0" max="360" value="0"
                    oninput="this.nextElementSibling.value = this.value"> <output>0</output>°</label>
            <br><br>
            <label>Vida (HP): <input type="range" id="hp" min="0" max="100" value="100"
                    oninput="this.nextElementSibling.value = this.value"> <output>100</output>%</label>
            <br><br>
            <button id="sendBtn" onclick="sendMovement()" disabled style="background: #007bff;">Enviar JSON</button>
        </div>

        <div style="flex: 2;">
            <h3>Consola de la Sala:</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        // Aquí me guardo mi conexión para poder usarla en todas mis funciones.
        let ws;

        function connect() {
            const username = document.getElementById('username').value;
            const room = document.getElementById('room_id').value;

            // Abro mi "tubería" (WebSocket) hacia el servidor.
            // Le paso la sala y mi nombre en la URL para que el servidor sepa quién soy.
            ws = new WebSocket(`ws://localhost:8000/ws/game/${room}/${username}`);

            // Este evento me salta cuando he logrado conectar bien.
            ws.onopen = function () {
                document.getElementById('status').innerText = `Estoy en la sala ${room} como ${username}`;
                document.getElementById('status').style.color = "#28a745";
                document.getElementById('sendBtn').disabled = false;
            };

            // Aquí es donde recibo todo lo que el servidor me "reparte" de mi sala.
            ws.onmessage = function (event) {
                // Paso el texto JSON que me llega a un objeto de JS que yo pueda manejar.
                const data = JSON.parse(event.data);
                const messages = document.getElementById('messages');
                const messageDiv = document.createElement('div');

                // Lógica que me he currado para mostrar los mensajes según el tipo:
                if (data.tipo === "sistema") {
                    // Mensajes automáticos del servidor (color amarillo).
                    messageDiv.style.color = "#ffc107";
                    messageDiv.innerText = `[AVISO SISTEMA] ${data.contenido}`;
                } else if (data.tipo === "movimiento") {
                    // Datos de los otros tanques que se están moviendo.
                    // Me he puesto lo de la vida en rojo si baja mucho para que se vea claro.
                    const colorVida = data.datos.vida > 30 ? '#28a745' : '#dc3545';
                    messageDiv.innerHTML = `<b>${data.jugador}:</b> X:${data.datos.x}, Y:${data.datos.y}, Rot:${data.datos.rotacion}°, <b style="color: ${colorVida}">HP:${data.datos.vida}%</b>`;
                }

                // Añado el mensaje a mi consola y hago que baje el scroll solo.
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            };

            // Si pierdo internet o el servidor se cae, me aviso aquí.
            ws.onclose = function () {
                document.getElementById('status').innerText = "Vaya, me he desconectado";
                document.getElementById('status').style.color = "#dc3545";
                document.getElementById('sendBtn').disabled = true;
            };
        }

        /**
         * Con esta función monto el paquete de datos de mi tanque
         * y lo mando por la tubería para que todos los demás me vean.
         */
        function sendMovement() {
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            const rot = document.getElementById('rot').value;
            const vida = document.getElementById('hp').value;

            // Este es mi "contrato" de datos. Tengo que mandar lo mismo desde Unity luego.
            const payload = {
                x: parseInt(x),
                y: parseInt(y),
                rotacion: parseInt(rot),
                vida: parseInt(vida)
            };

            // Convierto mi objeto a texto para que el servidor pueda masticarlo.
            ws.send(JSON.stringify(payload));
        }
    </script>
</body>

</html>